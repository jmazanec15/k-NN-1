{% import "benchmark.helpers" as benchmark with context %}
{
    "version": 2,
    "description": "k-NN Plugin train workload",
    "indices": [
        {
            "name": "{{ target_index_name | default("target_index") }}",
            "body": "target-index.json"
        },
        {
            "name": "{{ train_index_name | default("train_index") }}",
            "body": "train-index.json"
        }
    ],
    "operations": {{ benchmark.collect(parts="operations/*.json") }},
    "schedule": [
        {
            "name": "delete-target-index",  
            "index": "{{ target_index_name | default("target_index") }}",
            "only-if-exists": true,
            "operation": "delete-index"
        },
        {
            "name": "delete-train-index",
            "index": "{{ train_index_name | default("train_index") }}",
            "only-if-exists": true,
            "operation": "delete-index"
        },
        {
            "operation": {
                "operation-type": "delete-model",
                "name": "delete-model",
                "model_id": "{{ model_id | default("test-model") }}"
            }
        },
        {
            "operation": {
                "name": "create-train-index",
                "operation-type": "create-index",
                "index": "{{ train_index_name | default("train_index") }}"
            }
        },
        {
            "name": "wait-for-train-index-to-be-green",
            "operation": "cluster-health",
            "request-params": {
                "wait_for_status": "green"
            }
        },
        {
            "operation": {
                "name": "train-vector-bulk",
                "operation-type": "custom-vector-bulk",
                "param-source": "bulk-from-data-set",
                "index": "{{ train_index_name | default("train_index") }}",
                "field": "{{ train_field_name | default("train_field") }}",
                "bulk_size": {{ train_bulk_size | default(200) }},
                "data_set_format": "{{ train_index_data_set_format }}",
                "data_set_path": "{{ train_index_data_set_path }}",
                "num_vectors": {{ train_vector_limit | default(100000000000000000) }}
            },
            "clients": {{ train_bulk_index_clients | default(1) }}
        },
        {
            "operation": {
                "name": "refresh-train-index",
                "operation-type": "custom-refresh",
                "index": "{{ train_index_name | default("train_index") }}",
                "retries": 100
            }
        },
        {
            "operation": "{{ model_method }}-train-model"
        },
        {
            "operation": {
                "name": "create-target-index",
                "operation-type": "create-index",
                "index": "{{ target_index_name | default("target_index") }}"
            }
        },
        {
            "name": "wait-for-target-index-to-be-green",
            "operation": "cluster-health",
            "request-params": {
                "wait_for_status": "green"
            }
        },
        {
            "operation": {
                "name": "custom-vector-bulk",
                "operation-type": "custom-vector-bulk",
                "param-source": "bulk-from-data-set",
                "index": "{{ target_index_name | default("target_index") }}",
                "field": "{{ target_field_name | default("target_field") }}",
                "bulk_size": {{ bulk_size | default(200) }},
                "data_set_format": "{{ bulk_index_data_set_format }}",
                "data_set_path": "{{ bulk_index_data_set_path }}"
            },   
            "clients": {{ bulk_index_clients | default(1) }}
        },
        {
            "operation": {
                "name": "refresh-target-index",
                "operation-type": "custom-refresh",
                "index": "{{ target_index_name|default("target_index") }}",
                "retries": 100
            }
        }
    ]
}
